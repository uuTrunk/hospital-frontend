<template>
  <div class="prescription-detail-container">
    <div class="back-button-container">
        <button @click="goBack" class="back-btn">&lt; 返回</button>
        <span class="detail-no">No.0006589 <span class="tag-a1">A1</span></span>
    </div>
    <div class="detail-content-wrapper">
        <div class="patient-info-sidebar">
            <div class="info-item"><span class="label">姓名</span> <span class="value name">王大勇�?/span></div>
            <div class="info-item"><span class="label">性别</span> <span class="value">�?/span></div>
            <div class="info-item"><span class="label">年龄</span> <span class="value">86周岁</span></div>
            <div class="info-item"><span class="label">房间床位</span> <span class="value">2206-5</span></div>
            <div class="info-item"><span class="label">入院编号</span> <span class="value">20240506124</span></div>
            <div class="info-item"><span class="label">费别</span> <span class="value">医保</span></div>
            <div class="info-item"><span class="label">医保卡号</span> <span class="value">D053252131</span></div>
            <div class="info-item"><span class="label">科别</span> <span class="value"></span></div>
            <div class="info-item"><span class="label">就诊日期</span> <span class="value">2024-05-12</span></div>
            <div class="info-item allergies-item">
                <span class="label">过敏史�?/span> 
                <span class="value allergies">青霉素、头孢、先锋类</span>
            </div>
        </div>
        <div class="prescription-main-content">
            <div class="detail-header">
                <div class="tabs-detail">
                    <span class="tab" :class="{active: activeTab === 'prescription'}" @click="switchTab('prescription')"> <i class="el-icon-document"></i> 电子处方 </span>
                    <span class="tab" :class="{active: activeTab === 'record'}" @click="switchTab('record')"> <i class="el-icon-document-copy"></i> 电子病历 </span>
                </div>
                <div v-if="activeTab === 'prescription'" class="prescription-header-content">
                    <div class="diagnosis-edit">
                        <span class="label">临床诊断</span> 
                        <!-- TODO: Make this an editable input/search -->
                         <span class="tag-diagnosis">头痛</span> 
                         <input type="text" placeholder="输入名称或助记码,按回车添加�?>
                    </div>
                    <button v-if="isEditingPrescription" class="btn-send-prescription" @click="savePrescription">发送处方</button>
                    <template v-else>
                        <div class="action-buttons-main">
                            <button class="btn-modify-main" @click="editPrescription">修改</button>
                            <button class="btn-print-main"><i class="el-icon-printer"></i> 打印处方</button>
                        </div>
                    </template>
                </div>
                 <div v-if="activeTab === 'record' && medicalRecordContent && !isEditingRecord" class="action-buttons-main">
                    <button class="btn-modify-main" @click="editRecord">修改</button>
                    <button class="btn-print-main" @click="printMedicalRecord"><i class="el-icon-printer"></i> 打印病历</button>
                </div>
                 <div v-if="activeTab === 'record' && (!medicalRecordContent || isEditingRecord)" class="action-buttons-main">
                     <button class="btn-save-record" @click="saveRecord"><i class="el-icon-check"></i> 保存病历</button>
                </div>
            </div>
            <div v-show="activeTab === 'prescription'">
                <!-- EDIT MODE Prescription Table (Fig 2) -->
                <div v-if="isEditingPrescription" class="prescription-edit-content">
                    <div class="prescription-actions">
                        <button @click="openDrugModal"><i class="el-icon-plus"></i> 药物</button>
                        <button disabled><i class="el-icon-copy-document"></i> 同组</button>
                        <button disabled><i class="el-icon-scissors"></i> 拆组</button>
                        <button @click="deleteSelectedRows"><i class="el-icon-delete"></i> 删除</button>
                    </div>
                    <div class="prescription-table-wrapper editable">
                        <table class="prescription-table-main editable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" title="�?></th>
                                    <th>组号</th>
                                    <th>内容</th>
                                    <th>规格</th>
                                    <th>*单次剂量</th>
                                    <th></th> <!-- Unit -->
                                    <th>*用法</th>
                                    <th>*频率</th>
                                    <th>给药时间</th>
                                    <th>天数</th>
                                    <th>*总量</th>
                                    <th></th> <!-- Unit -->
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(item, index) in prescriptionItems" :key="item.id">
                                    <td><input type="checkbox" v-model="item.selected"></td>
                                    <td>{{ index + 1 }}</td> 
                                    <td><input type="text" v-model="item.content"></td>
                                    <td><input type="text" v-model="item.spec"></td>
                                    <td><input type="number" v-model="item.dose"></td>
                                    <td><input type="text" v-model="item.doseUnit" placeholder="单位"></td>
                                    <td>
                                        <select v-model="item.usage">
                                            <option value="">选择用法</option>
                                            <option value="口服(po)">口服(po)</option>
                                            <option value="静脉滴注(ivdrip)">静脉滴注(ivdrip)</option>
                                            <option value="外用">外用</option>
                                            <!-- Add more options -->
                                        </select>
                                    </td>
                                     <td>
                                        <select v-model="item.frequency">
                                            <option value="">选择频率</option>
                                             <option value="每天1�?qd)">每天1�?qd)</option>
                                             <option value="每天2�?bid)">每天2�?bid)</option>
                                             <option value="每天3�?tid)">每天3�?tid)</option>
                                             <!-- Add more options -->
                                        </select>
                                    </td>
                                    <td>
                                         <select v-model="item.timing">
                                             <option value="">选择时间</option>
                                             <option value=""></option>
                                             <option value="睡前(hs)">睡前(hs)</option>
                                              <!-- Add more options -->
                                         </select>
                                    </td>
                                    <td><input type="number" v-model="item.days"></td>
                                    <td><input type="number" v-model="item.total"></td>
                                    <td><input type="text" v-model="item.totalUnit" placeholder="单位"></td>
                                </tr>
                                <!-- Add Row Button -->
                                <tr>
                                    <td colspan="12" class="add-row-cell">
                                        <button @click="addRow" class="btn-add-row">+ 添加</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="prescription-instructions">
                        <ol>
                            <li>1, 无分组分�?/li>
                            <li>2, 多选同组操作：A, 如所选药品中无分组组，则自动成为一组；B, 如所选药品中�?个组，则将单独的药品加入到此组末尾；C, 如所选药品中有不�?个组，则提示"不可将多个组合并"�?/li>
                            <li>3, 多选拆组操作：自动将所选药品中有组的部分开�?/li>
                            <li>4, 同组后，次药行展示置顶图标，点击后自动将此药设为本组的主药�?/li>
                            <li>5, 左侧栏的长者个人信息的内容，部快捷存储�?/li>
                        </ol>
                    </div>
                </div>

                 <!-- READ-ONLY MODE Prescription Table -->
                <div v-else class="prescription-table-wrapper">
                    <table class="prescription-table-main read-only">
                         <thead>
                            <tr>
                                <!-- Adjust headers for read-only view if needed -->
                                <th>组号</th>
                                <th>内容</th>
                                <th>规格</th>
                                <th>单次剂量</th>
                                <th>用法</th>
                                <th>频率</th>
                                <th>给药时间</th>
                                <th>天数</th>
                                <th>总量</th>
                                <th>来源</th>
                            </tr>
                        </thead>
                         <tbody>
                             <!-- Iterate through prescription items -->
                            <template v-for="item in prescriptionData?.items" :key="item.id">
                                <tr :class="{'group-start': item.isGroupLead}">
                                    <td>{{ item.group }}</td>
                                    <td>
                                        <span v-if="item.isGroupLead" class="tag-item">{{ item.subItems ? item.subItems.length + 1 : 1 }}</span> 
                                        {{ item.content }}
                                    </td>
                                    <td>{{ item.spec }}</td>
                                    <td>{{ item.dose }}{{ item.doseUnit }}</td>
                                    <td>{{ item.usage }}</td>
                                    <td>{{ item.frequency }}</td>
                                    <td>{{ item.timing }}</td>
                                    <td>{{ item.days }}</td>
                                    <td>{{ item.total }}{{ item.totalUnit }}</td>
                                    <td>{{ item.source }}</td>
                                </tr>
                                <!-- Render sub-items if they exist -->
                                <tr v-for="(subItem, subIndex) in item.subItems" 
                                    :key="subItem.id" 
                                    class="group-item" 
                                    :class="{'last-item': subIndex === item.subItems.length - 1}">
                                    <td></td> <!-- Empty cell for group number -->
                                    <td>
                                        <span class="sub-item-indent" :class="{'last-indent': subIndex === item.subItems.length - 1}">
                                            {{ subIndex === item.subItems.length - 1 ? '�? : '|' }}
                                        </span> 
                                        {{ subItem.content }}
                                    </td>
                                    <td>{{ subItem.spec }}</td>
                                    <td>{{ subItem.dose }}{{ subItem.doseUnit }}</td>
                                    <td></td> <!-- Empty cells for usage, freq, etc. -->
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>{{ subItem.total }}{{ subItem.totalUnit }}</td>
                                    <td>{{ subItem.source }}</td>
                                </tr>
                            </template>
                            <tr v-if="!prescriptionData || !prescriptionData.items || prescriptionData.items.length === 0">
                                <td colspan="10" class="no-data-row">暂无分组处方数据</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Electronic Medical Record Content -->
            <div v-show="activeTab === 'record'">
                <!-- View Mode (Fig. 1) -->
                <div v-if="medicalRecordContent && !isEditingRecord" class="record-view-content">
                    <div class="record-view-section">
                        <span class="label">主诉</span>
                        <p>{{ medicalRecordContent.chiefComplaint }}</p>
                    </div>
                    <div class="record-view-section">
                        <span class="label">现病�?/span>
                        <p>{{ medicalRecordContent.presentHistory }}</p>
                    </div>
                    <div class="record-view-section">
                        <span class="label">既往�?/span>
                        <p>{{ medicalRecordContent.pastHistory }}</p>
                    </div>
                     <div class="record-view-section">
                        <span class="label">体检情况</span>
                        <p>T <span class="vital-value">{{ medicalRecordContent.temperature }}</span>℃，{{ medicalRecordContent.physicalExamNotes }}</p>
                    </div>
                     <div class="record-view-section">
                        <span class="label">临床诊断</span>
                        <p>{{ medicalRecordContent.clinicalDiagnosis }}</p>
                    </div>
                    <div class="record-view-section">
                        <span class="label">处理意见</span>
                        <p>{{ medicalRecordContent.treatmentOpinion }}</p>
                    </div>
                </div>

                <!-- Edit/Create Mode (Fig. 3) -->
                <div v-else class="record-edit-form">
                    <div class="template-selector-container">
                        <div class="template-selector-header">
                            <button class="btn-template" :class="{active: showTemplateSelectorContent}" @click.stop="toggleTemplateSelector">
                                <i class="el-icon-folder-opened"></i> 选择模板
                            </button>
                            <span class="template-hint">另存为模�?/span>
                        </div>
                        <!-- Template Search and List (Conditionally Shown) -->
                        <div v-if="showTemplateSelectorContent" class="template-selector-content">
                            <div class="template-search">
                                <input type="text" v-model="templateSearch" placeholder="模板名称">
                                <i class="el-icon-search"></i>
                            </div>
                            <ul class="template-list">
                                <li v-for="template in filteredTemplates" 
                                    :key="template.id" 
                                    @click="selectTemplate(template)">
                                    <span class="bullet">�?/span> {{ template.name }}
                                </li>
                                <li v-if="filteredTemplates.length === 0" class="no-results">
                                    无分组匹配模�?
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="chiefComplaint">主诉</label>
                        <textarea id="chiefComplaint" v-model="recordForm.chiefComplaint" rows="2"></textarea>
                    </div>
                     <div class="form-group">
                        <label for="presentHistory">现病�?/label>
                        <textarea id="presentHistory" v-model="recordForm.presentHistory" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="pastHistory">既往�?/label>
                        <textarea id="pastHistory" v-model="recordForm.pastHistory" rows="2"></textarea>
                    </div>
                    <div class="form-group form-group-inline">
                        <label>体检情况</label>
                        <div class="inline-inputs">
                            <span>T</span> <input type="text" v-model="recordForm.temperature" placeholder="�?> <span>�?/span>
                            <span>P</span> <input type="text" v-model="recordForm.pulse" placeholder="�?�?> <span>�?�?/span>
                            <span>R</span> <input type="text" v-model="recordForm.respiration" placeholder="�?�?> <span>�?�?/span>
                            <span>BP</span> <input type="text" v-model="recordForm.bpSystolic" placeholder="收缩�?> / <input type="text" v-model="recordForm.bpDiastolic" placeholder="舒张�?> <span>mmHg</span>
                        </div>
                         <textarea v-model="recordForm.physicalExamNotes" rows="3" placeholder="体格描述"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="auxiliaryExam">辅助检�?/label>
                        <textarea id="auxiliaryExam" v-model="recordForm.auxiliaryExam" rows="3" placeholder="辅助检查结�?></textarea>
                    </div>
                    <div class="form-group">
                        <label for="clinicalDiagnosis">临床诊断</label>
                        <textarea id="clinicalDiagnosis" v-model="recordForm.clinicalDiagnosis" rows="2" placeholder="输入名称/编码/助记码，按回车添加�?></textarea>
                    </div>
                     <div class="form-group">
                        <label for="treatmentOpinion">处理意见</label>
                        <textarea id="treatmentOpinion" v-model="recordForm.treatmentOpinion" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Medical Record Print Modal -->
     <div v-if="showRecordPrintModal" class="record-print-modal-backdrop" @click="closeRecordPrintModal">
        <div class="record-print-modal" @click.stop>
            <div class="record-print-header">
                <h3>电子病历打印预览</h3>
                 <button class="close-btn" @click="closeRecordPrintModal">×</button>
            </div>
             <div class="record-print-content">
                <div class="record-print-header-info">
                     <span class="print-date">2024�?�?�?/span>
                     <span class="print-institution">XX机构</span>
                 </div>
                 <div class="record-print-section">
                    <span class="label">主诉:</span>
                    <span class="content">{{ medicalRecordContent?.chiefComplaint }}</span>
                </div>
                 <div class="record-print-section">
                    <span class="label">现病�?</span>
                    <span class="content">{{ medicalRecordContent?.presentHistory }}</span>
                </div>
                 <div class="record-print-section">
                    <span class="label">既往�?</span>
                    <span class="content">{{ medicalRecordContent?.pastHistory }}</span>
                </div>
                 <div class="record-print-section">
                    <span class="label">体检:</span>
                    <span class="content">T {{ medicalRecordContent?.temperature }}℃，{{ medicalRecordContent?.physicalExamNotes }}</span>
                </div>
                 <div class="record-print-section">
                     <span class="label">辅助检�?</span>
                     <span class="content">{{ medicalRecordContent?.auxiliaryExam }}</span>
                 </div>
                 <div class="record-print-section">
                    <span class="label">诊断:</span>
                    <span class="content">{{ medicalRecordContent?.clinicalDiagnosis }}</span>
                </div>
                 <div class="record-print-section">
                    <span class="label">处理:</span>
                     <span class="content">{{ medicalRecordContent?.treatmentOpinion }}</span>
                </div>
                <div class="record-print-signature">
                    <span>医师签名:</span>
                    <span>{{ medicalRecordContent?.doctorSignature || '张医�? }}</span>
                </div>
            </div>
             <div class="record-print-footer">
                <button class="btn-close-print" @click="closeRecordPrintModal">关闭</button>
                 <button class="btn-confirm-print" @click="doPrintRecord"><i class="el-icon-printer"></i> 打印病历</button>
            </div>
        </div>
    </div>

    <!-- Drug Selection Modal -->
    <div v-if="showDrugModal" class="drug-modal-backdrop" @click.self="closeDrugModal">
        <div class="drug-modal">
            <div class="drug-modal-header">
                <h3>添加药品</h3>
                <button class="close-btn" @click="closeDrugModal">&times;</button>
            </div>
            <div class="drug-modal-body">
                <div class="drug-search-controls">
                    <select v-model="drugFilter.category" class="drug-category-select">
                        <option value="all">部分类</option>
                        <option value="western">西药</option>
                        <option value="chinese">中成�?/option>
                        <option value="herbal">中草�?/option>
                    </select>
                    <div class="drug-search-input-wrapper">
                        <input type="text" v-model="drugFilter.keyword" placeholder="名称/条码/编码/助记�? @keyup.enter="searchDrugs">
                        <i class="el-icon-search" @click="searchDrugs"></i>
                    </div>
                </div>
                <div class="drug-action-buttons">
                     <button class="drug-tab-btn active">药品�?/button>
                     <button class="drug-tab-btn">长者药�?{{ elderDrugCount }})</button>
                 </div>

                <div class="drug-list-container">
                    <table class="drug-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" @change="toggleSelectAllDrugs" :checked="isAllDrugsSelected"></th>
                                <th>药品名称</th>
                                <th>规格</th>
                                <th>包装单位</th>
                                <th>单价(�?</th>
                                <th>可用库存</th>
                                <th>厂家</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-if="paginatedDrugs.length === 0">
                                <td colspan="7" class="no-drugs">暂无分组药品数据</td>
                            </tr>
                            <tr v-for="drug in paginatedDrugs" :key="drug.id">
                                <td><input type="checkbox" :value="drug.id" v-model="selectedDrugIdsInModal"></td>
                                <td>{{ drug.name }}<br><span class="drug-code">{{ drug.code }}</span></td>
                                <td>{{ drug.spec }}</td>
                                <td>{{ drug.packageUnit }}</td>
                                <td>{{ drug.price?.toFixed(2) }}</td>
                                <td>{{ drug.stock }}</td>
                                <td>{{ drug.manufacturer }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="drug-pagination">
                     <button @click="changeDrugPage(drugPagination.currentPage - 1)" :disabled="drugPagination.currentPage <= 1">&lt;</button>
                     <span>
                        <button v-for="page in drugPageNumbers" :key="page"
                                @click="changeDrugPage(page)"
                                :class="{ active: page === drugPagination.currentPage }">
                            {{ page }}
                        </button>
                     </span>
                     <button @click="changeDrugPage(drugPagination.currentPage + 1)" :disabled="drugPagination.currentPage >= totalDrugPages">&gt;</button>
                </div>
            </div>
            <div class="drug-modal-footer">
                <div class="hint-box">
                    西医处方，只展示西药+中成�?br>
                    需要提供分页，跨TAB页，跨搜索条件多选能力；<br>
                    【可选交互】本页面勾选时，一次最多选择5种药物（选第六个的时候，弹出提示：一次最多只能选择5种药物）
                </div>
                <button class="btn-cancel-drug" @click="closeDrugModal">取消</button>
                <button class="btn-confirm-drug" @click="confirmAddDrugs">提交</button>
            </div>
        </div>
    </div>

  </div>
</template>

<script>
export default {
  name: 'PrescriptionDetail',
  props: ['id'], // 接收路由参数 id
  data() {
    return {
      activeTab: 'prescription', // 默认显示电子处方
      // 模拟的病历内容，如果为null 则显示编辑表�?
      medicalRecordContent: null, // Initial state, no record
        // { 
        // chiefComplaint: '咳嗽无分组痰4天有余，加重1�?,
        // presentHistory: '咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日咳嗽无分组�?天有余，加重1�?,
        // pastHistory: '咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日咳嗽无分组�?天有余，加重1�?,
        // temperature: '37.2',
        // pulse: '', 
        // respiration: '',
        // bpSystolic: '',
        // bpDiastolic: '',
        // physicalExamNotes: '咳嗽无分组痰4天有余，加重1�?,
        // auxiliaryExam: '', // 辅助检?
        // clinicalDiagnosis: '上呼吸道感染',
        // treatmentOpinion: '注意休息，按时服?
        // doctorSignature: '张医? // 医师签名 (如果需?
        // },
      isEditingRecord: false, // 是否处于病历编辑状�?
      recordForm: { // 用于编辑/创建病历的表单数�?
        chiefComplaint: '',
        presentHistory: '',
        pastHistory: '',
        temperature: '',
        pulse: '',
        respiration: '',
        bpSystolic: '',
        bpDiastolic: '',
        physicalExamNotes: '',
        auxiliaryExam: '',
        clinicalDiagnosis: '',
        treatmentOpinion: ''
      },
      showRecordPrintModal: false, // 控制病历打印模态框的显�?
      showTemplateSelectorContent: false, // 控制模板选择器的显示
      templateSearch: '', // 用于搜索模板
      // 模拟模板数据
      templates: [
        {
          id: 1,
          name: '上呼吸道感染',
          chiefComplaint: '咳嗽、流涕、发热',
          presentHistory: '患者3天前无分组明显诱因出现咳嗽、流涕，伴发热，体温最高38.5℃，无分组寒战、咳痰、胸痛等不适',
          clinicalDiagnosis: '急性上呼吸道感染'
        },
        {
          id: 2,
          name: '高血压、冠心病',
          chiefComplaint: '胸闷、心悸反复发作半年，加重3天',
          presentHistory: '患者半年前活动后出现胸闷、心悸，休息后可缓解。3天前症状加重，伴头晕、乏力',
          clinicalDiagnosis: '冠心病，高血压病 III级'
        },
        {
          id: 3,
          name: '老年痴呆',
          chiefComplaint: '记忆力下降、反应迟钝',
          presentHistory: '患者近2年逐渐出现记忆力下降，近期加重，伴反应迟钝、言语减少、生活自理能力下降',
          clinicalDiagnosis: '阿尔茨海默病'
        },
        {
          id: 4,
          name: '美尼尔综合征',
          chiefComplaint: '阵发性眩晕、耳鸣、听力下降',
          presentHistory: '患者1周前无分组诱因出现旋转性眩晕，持续数小时，伴恶心、呕吐、耳鸣及右耳听力下降',
          clinicalDiagnosis: '美尼尔综合征'
        }
      ],
      filteredTemplates: [],
      
      // --> New/Modified for Prescription Edit State <--
      prescriptionData: null, // Holds fetched prescription data (if any)
      isEditingPrescription: false, // Controls prescription edit mode
      prescriptionItems: [], // Array to hold editable prescription items
      showDrugModal: false, // Controls drug selection modal
      drugSearch: '', // Search term for drugs
      availableDrugs: [ // Mock drug list
        { id: 'd1', name: '阿莫西林胶囊', spec: '0.25g*24粒', unit: '盒' },
        { id: 'd2', name: '布洛芬缓释胶囊', spec: '0.3g*12粒', unit: '盒' },
        { id: 'd3', name: '维生素C片', spec: '100mg*100片', unit: '瓶' },
        { id: 'd4', name: '0.9%氯化钠注射液', spec: '500ml*1袋', unit: '袋' },
        { id: 'd5', name: '头孢呋辛酯片', spec: '0.25g*12片', unit: '盒' },
        { id: 'd6', name: '蒙脱石散', spec: '3g*10袋', unit: '盒' },
      ],
      filteredDrugs: [],
      selectedDrugs: [], // Holds drugs selected in the modal

      // Data for Drug Modal
      drugFilter: {
        category: 'all',
        keyword: ''
      },
      elderDrugCount: 3, // Example count
      selectedDrugIdsInModal: [],
      drugPagination: {
        currentPage: 1,
        pageSize: 5 // Adjust page size as needed
      },
    };
  },
  computed: {
    isReadOnly() {
      return !this.isEditingPrescription && this.activeTab === 'prescription';
    },
    isRecordReadOnly() {
      return !this.isEditingRecord && this.activeTab === 'record';
    },
    filteredRecordTemplates() {
      if (!this.templateSearch) {
        return this.templates;
      }
      const lowerSearch = this.templateSearch.toLowerCase();
      return this.templates.filter(t => t.name.toLowerCase().includes(lowerSearch));
    },
    filteredAvailableDrugs() {
      let drugs = this.availableDrugs;
      // Filter by category
      if (this.drugFilter.category !== 'all') {
        drugs = drugs.filter(d => d.category === this.drugFilter.category);
      }
      // Filter by keyword
      if (this.drugFilter.keyword) {
        const lowerKeyword = this.drugFilter.keyword.toLowerCase();
        drugs = drugs.filter(d =>
          d.name.toLowerCase().includes(lowerKeyword) ||
          d.code.toLowerCase().includes(lowerKeyword)
          // Add other searchable fields like pinyin etc. if needed
        );
      }
       // Requirement: "西医处方，只展示西药+中成�?
       drugs = drugs.filter(d => d.category === 'western' || d.category === 'chinese');

      return drugs;
    },
    totalDrugPages() {
      return Math.ceil(this.filteredAvailableDrugs.length / this.drugPagination.pageSize);
    },
    paginatedDrugs() {
      const start = (this.drugPagination.currentPage - 1) * this.drugPagination.pageSize;
      const end = start + this.drugPagination.pageSize;
      return this.filteredAvailableDrugs.slice(start, end);
    },
    isAllDrugsSelected() {
      if (this.paginatedDrugs.length === 0) return false;
      return this.paginatedDrugs.every(drug => this.selectedDrugIdsInModal.includes(drug.id));
    },
    drugPageNumbers() {
      const pages = [];
      const maxPagesToShow = 5; // Example: Show up to 5 page numbers
      let startPage = Math.max(1, this.drugPagination.currentPage - Math.floor(maxPagesToShow / 2));
      let endPage = Math.min(this.totalDrugPages, startPage + maxPagesToShow - 1);

      if (endPage - startPage + 1 < maxPagesToShow) {
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        pages.push(i);
      }
       // Add ellipsis if needed (simplified version)
       if (startPage > 1) pages.unshift('...');
       if (endPage < this.totalDrugPages) pages.push('...');

      return pages; // Note: ellipsis are just strings here, clicking them needs special handling or disable them
    }
  },
  methods: {
    goBack() {
      this.$router.go(-1); // 返回上一�?
    },
    switchTab(tab) {
      this.activeTab = tab;
      // 如果切换到病历tab且没有内容，则自动进入编辑状�?
      if (tab === 'record' && !this.medicalRecordContent) {
         this.isEditingRecord = true;
         // 可以选择性地清空或预填表�?
         // this.recordForm = { ... }; 
      } else if (tab === 'record' && this.medicalRecordContent) {
          this.isEditingRecord = false; // 如果有内容，默认显示查看模式
      }
    },
    editRecord() {
      // 将现有病历内容填充到表单
      if (this.medicalRecordContent) {
        this.recordForm = { ...this.medicalRecordContent };
      }
      this.isEditingRecord = true;
    },
    saveRecord() {
      // TODO: 实现保存病历的逻辑 (例如发送API请求)
      // 假设保存成功:
      this.medicalRecordContent = { ...this.recordForm }; 
      this.isEditingRecord = false; // 切换回查看模�?
      alert('病历已保�?);
    },
    printMedicalRecord() {
      // 确保有内容才打开打印预览
       if (this.medicalRecordContent) {
            this.showRecordPrintModal = true;
       } else {
           alert('没有可打印的病历内容');
       }
    },
    closeRecordPrintModal() {
      this.showRecordPrintModal = false;
    },
    doPrintRecord() {
      // TODO: 实现调用浏览器打印功能的逻辑，可能需要打印特定区�?
      alert('正在打印病历...');
      this.closeRecordPrintModal();
    },
    toggleTemplateSelector() {
      this.showTemplateSelectorContent = !this.showTemplateSelectorContent;
    },
    selectTemplate(template) {
      this.selectedRecordTemplateId = template.id;
      // Deep copy template content to avoid modifying original
      this.medicalRecordContent = JSON.parse(JSON.stringify(template.content));
      this.showTemplateSelectorContent = false; // Close dropdown
       this.templateSearch = ''; // Clear search
       // Optionally focus the first field or scroll
    },
    openDrugModal() {
      this.selectedDrugIdsInModal = []; // Reset selection when opening
      this.drugPagination.currentPage = 1; // Reset to first page
      this.showDrugModal = true;
    },
    closeDrugModal() {
      this.showDrugModal = false;
    },
    searchDrugs() {
      this.drugPagination.currentPage = 1; // Reset page on new search
      // The computed property `filteredAvailableDrugs` handles the filtering
    },
    toggleSelectAllDrugs(event) {
      if (event.target.checked) {
        // Select all drugs on the CURRENT page
        this.paginatedDrugs.forEach(drug => {
          if (!this.selectedDrugIdsInModal.includes(drug.id)) {
            this.selectedDrugIdsInModal.push(drug.id);
          }
        });
      } else {
        // Deselect all drugs on the CURRENT page
        const pageDrugIds = this.paginatedDrugs.map(d => d.id);
        this.selectedDrugIdsInModal = this.selectedDrugIdsInModal.filter(id => !pageDrugIds.includes(id));
      }
    },
    changeDrugPage(page) {
      if (page >= 1 && page <= this.totalDrugPages) {
        this.drugPagination.currentPage = page;
      }
      // Handle ellipsis clicks if implemented more robustly
    },
    confirmAddDrugs() {
      const drugsToAdd = this.availableDrugs.filter(drug => this.selectedDrugIdsInModal.includes(drug.id));

       // Check drug limit (max 5)
       const currentDrugCount = this.prescriptionData?.items?.length || 0;
       if (currentDrugCount + drugsToAdd.length > 5) {
           alert('一次最多只能选择5种药�?);
           return;
       }

      if (drugsToAdd.length > 0) {
           const newItems = drugsToAdd.map(drug => ({
               id: Date.now() + Math.random(), // Simple unique ID
               group: null, // Or assign group logic later
               isGroupLead: false,
               content: drug.name,
               spec: drug.spec,
               dose: '', // User needs to fill these
               doseUnit: '',
               usage: '',
               frequency: '',
               timing: '',
               days: null,
               totalAmount: null,
               totalAmountUnit: drug.packageUnit, // Default to package unit
               source: '自开', // Or based on context
               selected: false,
               drugId: drug.id // Link back to the original drug if needed
           }));

          if (!this.prescriptionData) {
              this.prescriptionData = { items: [] };
          }
          // Ensure items array exists
          if (!this.prescriptionData.items) {
               this.prescriptionData.items = [];
          }

          this.prescriptionData.items.push(...newItems);
      }
      this.closeDrugModal();
    },
    addRow() {
      if (!this.prescriptionData) {
          this.prescriptionData = { items: [] };
      }
       if (!this.prescriptionData.items) {
            this.prescriptionData.items = [];
       }
      this.prescriptionData.items.push({
          id: Date.now(), // Simple unique ID
          group: null,
          isGroupLead: false,
          content: '',
          spec: '',
          dose: '',
          doseUnit: '',
          usage: '',
          frequency: '',
          timing: '',
          days: null,
          totalAmount: null,
          totalAmountUnit: '',
          source: '自开',
          selected: false
      });
    },
    deleteSelectedRows() {
      if (!this.prescriptionData || !this.prescriptionData.items) return;
      this.prescriptionData.items = this.prescriptionData.items.filter(item => !item.selected);
      // Reset selection states if needed (though filtering removes them)
    },
    groupSelectedRows() {
      if (!this.prescriptionData || !this.prescriptionData.items) return;
      const selectedItems = this.prescriptionData.items.filter(item => item.selected);
      if (selectedItems.length < 2) {
          alert('请至少选择两行药品进行同组操作');
          return;
      }

      // Find the next available group number
      const existingGroups = new Set(this.prescriptionData.items.map(item => item.group).filter(g => g !== null));
      let nextGroup = 1;
      while (existingGroups.has(String(nextGroup))) {
          nextGroup++;
      }
      const groupNum = String(nextGroup);

      selectedItems.forEach((item, index) => {
          item.group = groupNum;
          item.isGroupLead = (index === 0); // Mark the first selected item as the group lead
          item.selected = false; // Deselect after grouping
      });

      // Reorder items to bring grouped items together (optional but good UX)
      // This is a simplified reorder, might need more robust logic
       this.prescriptionData.items.sort((a, b) => {
           const groupA = a.group || 'zzzz'; // Null groups last
           const groupB = b.group || 'zzzz';
           if (groupA !== groupB) {
               return groupA.localeCompare(groupB);
           }
           // Keep original relative order within group if possible (difficult without original index)
           return 0; // Simplification: don't reorder within group here
       });

       console.log('Grouped items with group #', groupNum);
    },
    ungroupSelectedRows() {
         if (!this.prescriptionData || !this.prescriptionData.items) return;
         const selectedItems = this.prescriptionData.items.filter(item => item.selected && item.group !== null);
          if (selectedItems.length === 0) {
             alert('请选择需要拆组的药品');
             return;
         }
         const groupsToUngroup = new Set(selectedItems.map(item => item.group));

        this.prescriptionData.items.forEach(item => {
            if (groupsToUngroup.has(item.group)) {
                item.group = null;
                item.isGroupLead = false;
            }
             item.selected = false; // Deselect after action
        });
         console.log('Ungrouped items from groups:', [...groupsToUngroup]);
    },
  },
  mounted() {
    console.log('Prescription/Record ID from route:', this.id);
    
    // --- Simulate Fetching Data Based on ID --- 
    const fetchData = () => {
        // Check if ID matches the one with details
        if (this.id === '0002658') { 
            console.log('Loading EXISTING data for ID: 0002658');
            // Populate with data resembling Fig 1 & 2
            this.prescriptionData = {
                clinicalDiagnosis: '头痛，脚�?,
                items: [
                    { id: 'p1', group: 1, content: '阿司匹林肠溶�?, spec: '0.25g*20�?, dose: '0.25', doseUnit: 'g', usage: '口服(po)', frequency: '每天1�?qd)', timing: '睡前(hs)', days: '4', total: '3', totalUnit: '�?, source: '内服' },
                    { id: 'p2', group: 2, content: '(维他凯尔)维生素C', spec: '10ml*5�?, dose: '适量', doseUnit: '', usage: '外用', frequency: '每天3�?tid)', timing: '', days: '7', total: '3', totalUnit: '�?, source: '自开' },
                    { id: 'p3a', group: 3, content: '0.9%葡萄糖注射液', spec: '500ml*1�?, dose: '0.25', doseUnit: 'g', usage: '静脉滴注(ivdrip)', frequency: '每天1�?qd)', timing: '', days: '3', total: '1', totalUnit: '�?, source: '内服', isGroupLead: true, subItems: [
                        { id: 'p3b', content: '头孢硫脒', spec: '0.25g*6�?, dose: '0.25', doseUnit: 'g', total: '1', totalUnit: '�?, source: '内服' },
                        { id: 'p3c', content: '青霉�?, spec: '0.25g*6�?, dose: '0.25', doseUnit: 'g', total: '1', totalUnit: '�?, source: '内服' },
                    ] },
                ]
            };
            this.medicalRecordContent = { 
                chiefComplaint: '咳嗽无分组痰4天有余，加重1�?,
                presentHistory: '咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日咳嗽无分组�?天有余，加重1�?,
                pastHistory: '咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日，咳嗽无分组痰4天有余，加重1日咳嗽无分组�?天有余，加重1�?,
                temperature: '37.2',
                pulse: '', 
                respiration: '',
                bpSystolic: '',
                bpDiastolic: '',
                physicalExamNotes: '咳嗽无分组痰4天有余，加重1�?,
                auxiliaryExam: '空腹血糖：5.5mmol/L，心电图：正�?, 
                treatmentOpinion: '注意休息，按时服�?,
                doctorSignature: '张医�? 
            };
            this.isEditingPrescription = false; // Start in view mode
            this.isEditingRecord = false;     // Start in view mode

        } else { // For 'new' or any other ID, start in add/edit mode
            console.log('Entering ADD/EDIT mode for Prescription and Record');
            this.prescriptionData = null;       
            this.medicalRecordContent = null; 
            this.isEditingPrescription = true;
            this.isEditingRecord = true;
            if (!this.prescriptionItems.length) {
                this.addRow();
            }
            this.recordForm = { chiefComplaint: '', presentHistory: '', /* ... other fields ... */ };
        }

        // Set active tab - default to prescription if editing prescription, otherwise maybe record?
        this.activeTab = this.isEditingPrescription ? 'prescription' : (this.isEditingRecord ? 'record' : 'prescription');

    };
    fetchData(); // Call the simulation
    // --- End Simulation --- 

    this.filterTemplates(''); 
    this.filterDrugs(''); 
  },
   beforeDestroy() {
    document.removeEventListener('click', this.closeDropdownOnClickOutside);
  }
};
</script>

<style scoped>
.prescription-detail-container {
  padding: 25px; /* Increased padding */
  background-color: #f7f8fa; /* Slightly off-white background */
  min-height: calc(100vh - 60px); /* Adjust based on actual header height */
  font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
}

.back-button-container {
    display: flex;
    align-items: center;
    margin-bottom: 20px; /* Increased margin */
    padding-bottom: 20px; /* Increased padding */
    border-bottom: 1px solid #e4e7ed; /* Lighter border */
}

.back-btn {
  background-color: #fff; /* White background */
  border: 1px solid #dcdfe6;
  color: #606266;
  padding: 6px 12px; /* Adjusted padding */
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px; /* Slightly larger font */
  margin-right: 25px; /* Increased margin */
  transition: all 0.2s ease; /* Smooth transition */
}

.back-btn:hover {
    background-color: #f5f7fa;
    border-color: #c0c4cc;
    color: #409eff; /* Highlight on hover */
}

.detail-no {
    font-size: 15px; /* Slightly larger */
    color: #303133;
    font-weight: 500; /* Medium weight */
}

.tag-a1 {
    background-color: #fff3e0; /* Lighter orange background */
    color: #ff9800; /* Brighter orange text */
    border: 1px solid #ffe0b2; /* Lighter orange border */
    padding: 2px 6px; /* Adjusted padding */
    border-radius: 3px;
    font-size: 12px;
    margin-left: 8px;
    font-weight: normal;
}

.detail-content-wrapper {
    display: flex;
    gap: 25px; /* Increased gap */
}

.patient-info-sidebar {
    width: 280px; /* Slightly wider */
    border: 1px solid #e4e7ed; /* Lighter border */
    border-radius: 5px; /* Slightly more rounded */
    padding: 20px; /* Increased padding */
    background-color: #fff; /* White background */
    height: fit-content;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle shadow */
}

.info-item {
    margin-bottom: 15px; /* Increased margin */
    font-size: 14px;
    color: #606266;
    display: flex;
    line-height: 1.6; /* Improved line height */
}

.info-item .label {
    width: 75px; /* Adjusted width */
    text-align: right;
    margin-right: 12px; /* Adjusted margin */
    color: #909399;
}

.info-item .value {
    color: #303133;
    flex: 1;
    word-break: break-all; /* Prevent long values overflowing */
}

.info-item .name {
    font-weight: 600; /* Bolder name */
    font-size: 17px; /* Larger name */
    color: #1f2d3d; /* Darker color */
}

.allergies-item .value {
    color: #f56c6c;
    font-weight: 500; /* Slightly bolder */
}

.prescription-main-content {
    flex: 1;
    background-color: #fff; /* White background for main content */
    border: 1px solid #e4e7ed; /* Lighter border */
    border-radius: 5px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle shadow */
}

.detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px; /* Increased margin */
    background-color: #fff; /* Removed background color here, applied to main content */
    padding: 0 0 15px 0; /* Remove padding, add bottom border */
    border-radius: 0;
    border-bottom: 1px solid #e4e7ed; /* Add bottom border */
}

.tabs-detail {
  display: inline-flex; /* Use inline-flex */
  gap: 0px;
  border: none; /* Remove outer border */
  border-radius: 0;
  overflow: visible;
  margin-right: auto; /* Push buttons to the right */
}

.tabs-detail .tab {
  padding: 10px 20px; /* Increased padding */
  cursor: pointer;
  font-size: 15px; /* Increased font size */
  background-color: transparent; /* Transparent background */
  color: #606266;
  border: none;
  border-bottom: 2px solid transparent; /* Underline effect */
  display: flex;
  align-items: center;
  gap: 6px;
  margin-right: 10px; /* Space between tabs */
  transition: all 0.2s ease;
}
.tabs-detail .tab:last-child {
    margin-right: 0;
}

.tabs-detail .tab i {
    font-size: 16px; /* Icon size */
}

.tabs-detail .tab:hover {
  color: #409eff;
}

.tabs-detail .tab.active {
  color: #409eff;
  font-weight: 600; /* Bolder active tab */
  border-bottom: 2px solid #409eff; /* Blue underline */
}

/* Container for buttons in the header */
.action-buttons-main {
    display: flex;
    gap: 10px; /* Space between buttons */
    margin-left: 20px; /* Space from the diagnosis/tabs */
}

/* Common style for action buttons */
.action-buttons-main button,
.btn-send-prescription,
.btn-save-record {
  padding: 8px 18px; /* Unified padding */
  border-radius: 4px;
  border: 1px solid;
  cursor: pointer;
  font-size: 14px;
  display: inline-flex; /* Use flex for icon alignment */
  align-items: center;
  justify-content: center;
  gap: 6px; /* Space between icon and text */
  transition: all 0.2s ease;
  white-space: nowrap; /* Prevent wrapping */
}

/* Primary button style (Save, Send) */
.btn-send-prescription,
.btn-save-record {
  background-color: #409eff;
  color: white;
  border-color: #409eff;
}
.btn-send-prescription:hover,
.btn-save-record:hover {
    background-color: #66b1ff;
    border-color: #66b1ff;
}
.btn-send-prescription:active,
.btn-save-record:active {
    background-color: #3a8ee6;
    border-color: #3a8ee6;
}

/* Secondary button style (Modify, Print) */
.btn-modify-main,
.btn-print-main {
  background-color: #fff;
  color: #409eff; /* Blue text */
  border-color: #b3d8ff; /* Light blue border */
}
.btn-modify-main:hover,
.btn-print-main:hover {
    background-color: #ecf5ff; /* Light blue background on hover */
    color: #3a8ee6;
    border-color: #a0cfff;
}
.btn-modify-main:active,
.btn-print-main:active {
    background-color: #d9ecff;
    color: #3a8ee6;
    border-color: #a0cfff;
}

.prescription-header-content {
    display: flex;
    justify-content: flex-start; /* Align items to the start */
    align-items: center;
    flex-grow: 0; /* Don't allow it to grow excessively */
    gap: 15px; /* Space between diagnosis and buttons */
    margin-left: auto; /* Push to the right, beside tabs */
}

.diagnosis-edit {
    display: flex;
    align-items: center;
    gap: 8px;
}

.diagnosis-edit .label {
    color: #909399;
    font-size: 14px;
    white-space: nowrap;
}

.tag-diagnosis {
    background-color: #f0f9eb; /* Light green background */
    color: #67c23a; /* Green text */
    border: 1px solid #e1f3d8; /* Light green border */
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 13px;
    margin-right: 5px;
}

.diagnosis-edit input[type="text"] {
    border: 1px solid #dcdfe6;
    border-radius: 4px;
    padding: 6px 10px; /* Adjusted padding */
    font-size: 13px;
    width: 220px; /* Adjust as needed */
    transition: border-color 0.2s ease;
}
.diagnosis-edit input[type="text"]:focus {
    border-color: #409eff;
    outline: none;
}

/* Keep action buttons grouped */
.prescription-header-content .action-buttons-main {
    margin-left: 0; /* Reset margin if it was moved */
}

/* Styles for Prescription Actions (Add Drug, Group, Delete etc.) */
.prescription-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 20px; /* Increased space below actions */
    padding-bottom: 20px;
    border-bottom: 1px solid #e4e7ed; /* Consistent border */
}

.prescription-actions button {
    padding: 7px 15px; /* Consistent padding */
    border-radius: 4px;
    border: 1px solid #dcdfe6;
    background-color: #fff;
    color: #606266;
    cursor: pointer;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
}

.prescription-actions button i {
    font-size: 15px;
}

.prescription-actions button:hover {
    background-color: #ecf5ff;
    color: #409eff;
    border-color: #b3d8ff;
}

.prescription-actions button:active {
    background-color: #d9ecff;
    border-color: #a0cfff;
}

.prescription-actions button:disabled {
    color: #c0c4cc;
    cursor: not-allowed;
    background-color: #f5f7fa;
    border-color: #e4e7ed;
}
.prescription-actions button:disabled:hover {
    background-color: #f5f7fa;
    color: #c0c4cc;
    border-color: #e4e7ed;
}

/* Style for Delete button */
.prescription-actions button.delete-btn {
    color: #f56c6c;
    border-color: #fbc4c4;
}
.prescription-actions button.delete-btn:hover {
    background-color: #fef0f0;
    color: #f78989;
    border-color: #fcd3d3;
}
.prescription-actions button.delete-btn:active {
    background-color: #fde2e2;
    color: #f78989;
    border-color: #fcd3d3;
}

/* --- Table Styles --- */
.prescription-table-wrapper {
    margin-top: 20px; /* Space above table */
    border: 1px solid #e4e7ed; /* Lighter border */
    border-radius: 4px;
    overflow: hidden; /* Prevents box-shadow leak */
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04); /* Subtle shadow */
}

.prescription-table-main {
  width: 100%;
  border-collapse: collapse; /* Ensure borders are clean */
}

/* Common cell styles */
.prescription-table-main th,
.prescription-table-main td {
  padding: 12px 10px; /* Increased padding */
  text-align: left;
  font-size: 13px;
  vertical-align: middle; /* Align vertically */
  border-bottom: 1px solid #f0f2f5; /* Lighter row separator */
}

/* Header styles */
.prescription-table-main th {
  background-color: #f9fafc; /* Lighter header background */
  color: #606266; /* Darker header text */
  font-weight: 500; /* Medium weight */
  white-space: nowrap;
}

/* Remove right border logic - use border-bottom only */
.prescription-table-main th,
.prescription-table-main td {
  border-right: none;
}


/* Read-Only Table Specific Styles */
.prescription-table-main.read-only td {
  color: #303133; /* Standard text color */
  line-height: 1.5;
}

/* Zebra striping for read-only table */
.prescription-table-main.read-only tbody tr:not(.group-item):nth-child(odd) {
   /* background-color: #fafcff; /* Very light blue stripe - Apply only to non-group items if complex */
}
/* Zebra striping for read-only table (simpler version) */
.prescription-table-main.read-only tbody tr:nth-child(odd) {
    /* Consider adding if group logic allows simple striping */
}

.tag-item {
    display: inline-block;
    background-color: #ecf5ff;
    color: #409eff;
    border: 1px solid #d9ecff;
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 11px;
    margin-right: 6px;
    font-weight: bold;
    min-width: 18px;
    text-align: center;
}

.sub-item-indent {
    display: inline-block;
    width: 20px; /* Indentation width */
    text-align: center;
    margin-right: 5px;
    color: #c0c4cc; /* Lighter color for lines */
    position: relative;
}

.group-item td {
    padding-left: 15px; /* Indent group items */
    position: relative;
    border-bottom-color: #f5f7fa; /* Lighter border for sub-items */
}

/* --- End Table Styles --- */

/* --- EMR View Mode Styles --- */
.record-view-content {
    padding: 20px 10px; /* Add some padding */
    line-height: 1.7; /* Improve readability */
    color: #303133; /* Standard text color */
}

.record-view-section {
    margin-bottom: 20px; /* Space between sections */
    display: flex; /* Align label and content */
    flex-direction: column; /* Stack label above content */
}

.record-view-section .label {
    font-weight: 600; /* Make label bold */
    color: #606266; /* Slightly lighter color for label */
    margin-bottom: 8px; /* Space between label and content */
    font-size: 14px; /* Match other labels */
}

.record-view-section p {
    margin: 0; /* Remove default paragraph margin */
    font-size: 14px; /* Standard content size */
    color: #303133;
    white-space: pre-wrap; /* Preserve line breaks from data */
}

.record-view-section .vital-value {
    font-weight: 500; /* Slightly bolder vital signs */
    color: #409eff; /* Highlight vital signs */
    margin: 0 2px;
}


/* --- Edit Form Styles --- */
.record-edit-form {
    padding: 25px; /* Increased padding */
    border: none; /* Remove border, main content has it */
    border-radius: 0;
    margin-top: 20px;
}

.template-selector-container {
    margin-bottom: 30px; /* Increased margin */
    position: relative; /* Needed for dropdown positioning */
}

.template-selector-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px; /* Space below header */
}

.btn-template {
    background-color: #fff;
    border: 1px solid #dcdfe6;
    color: #606266;
    padding: 8px 15px; /* Adjusted padding */
    border-radius: 4px;
    cursor: pointer;
    margin-right: 15px;
    font-size: 14px; /* Increased size */
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease;
}
.btn-template i {
    font-size: 16px;
}

.btn-template:hover,
.btn-template.active {
    border-color: #409eff;
    color: #409eff;
    background-color: #ecf5ff;
}

.template-hint {
    color: #409eff; /* Blue color for link-like appearance */
    font-size: 14px;
    cursor: pointer;
    transition: color 0.2s ease;
}
.template-hint:hover {
    color: #66b1ff;
}

/* Template Dropdown Content */
.template-selector-content {
    border: 1px solid #e4e7ed; /* Lighter border */
    border-radius: 4px;
    width: 350px; /* Wider dropdown */
    background-color: #fff;
    box-shadow: 0 2px 12px 0 rgba(0,0,0,.1); /* Standard dropdown shadow */
    z-index: 10; /* Ensure it's above other content */
    max-height: 300px; /* Increased max height */
    display: flex;
    flex-direction: column;
    margin-top: 8px; /* Space from header */
    position: absolute; /* Position absolutely */
    top: 100%;
    left: 0;
}

.template-search {
  padding: 8px 12px; /* Adjusted padding */
  border-bottom: 1px solid #f0f2f5; /* Lighter separator */
  display: flex;
  align-items: center;
}

.template-search input {
  flex-grow: 1;
  border: 1px solid #dcdfe6; /* Keep border */
  outline: none;
  font-size: 13px;
  padding: 6px 10px; /* Input padding */
  border-radius: 3px;
}
.template-search input:focus {
    border-color: #409eff;
}

.template-search .el-icon-search {
    color: #c0c4cc;
    margin-left: 10px;
    cursor: pointer;
    font-size: 16px;
}

.template-list {
  list-style: none;
  margin: 0;
  padding: 5px 0;
  overflow-y: auto;
  flex-grow: 1;
}

.template-list li {
  padding: 8px 15px; /* Increased padding */
  font-size: 14px;
  color: #606266;
  cursor: pointer;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: flex;
  align-items: center;
  transition: background-color 0.2s ease;
}

.template-list li .bullet {
    font-size: 16px;
    margin-right: 10px; /* Increased margin */
    color: #c0c4cc; /* Lighter bullet */
    line-height: 1; /* Align bullet better */
}

.template-list li:hover {
  background-color: #f5f7fa; /* Subtle hover */
  color: #409eff;
}

.template-list .no-results {
    padding: 15px; /* Increased padding */
    color: #909399;
    font-style: italic;
    cursor: default;
    text-align: center;
}
.template-list .no-results:hover {
    background-color: transparent;
    color: #909399;
}

/* Form Group Styling */
.form-group {
    margin-bottom: 22px; /* Increased margin */
}

.form-group label {
    display: block;
    margin-bottom: 8px; /* Increased margin */
    font-weight: 500; /* Medium weight */
    font-size: 14px;
    color: #303133; /* Darker label */
}

.form-group textarea,
.form-group input[type="text"]:not(.inline-inputs input) {
    width: 100%;
    padding: 10px 12px; /* Increased padding */
    border: 1px solid #dcdfe6;
    border-radius: 4px;
    font-size: 14px;
    line-height: 1.5;
    color: #303133;
    transition: border-color 0.2s ease;
    box-sizing: border-box;
}
.form-group textarea {
    resize: vertical;
    min-height: 60px; /* Minimum height for textareas */
}

.form-group textarea:focus,
.form-group input[type="text"]:not(.inline-inputs input):focus {
    border-color: #409eff;
    outline: none;
}

/* Inline Vital Signs */
.form-group-inline > label {
     margin-bottom: 12px;
}

.inline-inputs {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px 15px; /* Adjusted gaps */
    margin-bottom: 12px;
}

.inline-inputs span {
    color: #606266;
    font-size: 14px;
    margin-left: 3px;
    margin-right: 12px;
    white-space: nowrap;
}
.inline-inputs span:last-of-type {
    margin-right: 0; /* Remove margin for last unit */
}

.inline-inputs input[type="text"] {
    width: 90px; /* Adjusted width */
    padding: 10px; /* Increased padding */
    border: 1px solid #dcdfe6;
    border-radius: 4px;
    font-size: 14px;
    text-align: center;
    transition: border-color 0.2s ease;
}
.inline-inputs input[type="text"]:focus {
    border-color: #409eff;
    outline: none;
}

.form-group-inline textarea {
    width: 100%;
    margin-top: 8px;
}


/* --- Print Modal Styles --- */
.record-print-modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5); /* Standard backdrop */
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1001; /* Ensure above other elements */
}

.record-print-modal {
  background-color: #fff;
  border-radius: 6px;
  width: 90%;
  max-width: 800px; /* A4-ish width */
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  max-height: 90vh;
}

.record-print-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  border-bottom: 1px solid #e4e7ed; /* Lighter border */
}

.record-print-header h3 {
  margin: 0;
  font-size: 17px; /* Slightly larger */
  font-weight: 600;
  color: #303133;
}

.record-print-modal .close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #909399; /* Standard close icon color */
  padding: 0;
  line-height: 1;
}
.record-print-modal .close-btn:hover {
    color: #f56c6c; /* Red hover for close */
}

.record-print-content {
  padding: 25px 30px; /* Increased padding */
  max-height: calc(90vh - 130px); /* Adjust based on header/footer */
  overflow-y: auto;
  font-family: 'SimSun', '宋体', serif; /* Use serif font for printing */
  line-height: 1.8; /* Improve print readability */
  color: #000; /* Black text for printing */
}
.record-print-header-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    font-size: 13px;
    color: #555;
}
.record-print-section {
    margin-bottom: 15px;
    display: flex; /* Align label and content */
}
.record-print-section .label {
    font-weight: bold;
    width: 80px; /* Fixed width for labels */
    flex-shrink: 0; /* Prevent label shrinking */
    margin-right: 10px;
}
.record-print-section .content {
    flex-grow: 1;
}

.record-print-signature {
    margin-top: 30px;
    text-align: right;
    font-size: 14px;
}
.record-print-signature span:first-child {
    margin-right: 10px;
}

.record-print-footer {
  display: flex;
  justify-content: flex-end;
  padding: 15px 20px;
  border-top: 1px solid #e4e7ed;
  background-color: #f9fafc; /* Light footer background */
}

/* Style footer buttons */
.record-print-footer button {
  padding: 8px 18px;
  border-radius: 4px;
  border: 1px solid;
  cursor: pointer;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all 0.2s ease;
}
.btn-close-print {
  background-color: #fff;
  color: #606266;
  border-color: #dcdfe6;
  margin-right: 10px;
}
.btn-close-print:hover {
    background-color: #f5f7fa;
    border-color: #c0c4cc;
}
.btn-confirm-print {
  background-color: #409eff;
  color: white;
  border-color: #409eff;
}
.btn-confirm-print:hover {
    background-color: #66b1ff;
    border-color: #66b1ff;
}

/* Keep existing modal styles for drug modal if needed */
/* Keep existing styles for group-start, group-item, last-item, tag-item, sub-item-indent, last-indent etc. */
.no-data-row td {
    text-align: center;
    color: #909399;
    padding: 30px; /* More padding for empty state */
    font-size: 14px;
}

/* Adjust editable table inputs for consistency */
.prescription-table-main.editable input[type="text"]:not([readonly]),
.prescription-table-main.editable input[type="number"]:not([readonly]),
.prescription-table-main.editable select:not([disabled]) {
    width: 100%;
    padding: 6px 8px; /* Keep slightly smaller for editable table */
    border: 1px solid #dcdfe6;
    border-radius: 4px;
    font-size: 13px;
    box-sizing: border-box;
    transition: border-color 0.2s ease;
}
.prescription-table-main.editable input:focus:not([readonly]),
.prescription-table-main.editable select:focus:not([disabled]) {
    border-color: #409eff;
    outline: none;
}

/* Keep existing modal styles for drug modal if needed */
/* --- Drug Modal Styles (Fig 2) --- */
.drug-modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6); /* Standard backdrop */
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000; /* High z-index */
}

.drug-modal {
  background-color: #fff;
  border-radius: 6px;
  width: 90%;
  max-width: 900px; /* Wider modal */
  box-shadow: 0 5px 20px rgba(0,0,0,0.25);
  display: flex;
  flex-direction: column;
  max-height: 90vh;
  overflow: hidden; /* Prevent content spill */
}

.drug-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 25px; /* Increased padding */
  border-bottom: 1px solid #e4e7ed;
}

.drug-modal-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #303133;
}

.drug-modal .close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #909399;
  padding: 0;
  line-height: 1;
}
.drug-modal .close-btn:hover {
    color: #f56c6c;
}

.drug-modal-body {
  padding: 20px 25px; 
  flex-grow: 1; /* Take remaining height */
  overflow-y: hidden; /* Prevent body scroll, inner container scrolls */
  display: flex;
  flex-direction: column;
  gap: 15px; /* Space between elements */
}

.drug-search-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.drug-category-select {
    padding: 8px 12px;
    border: 1px solid #dcdfe6;
    border-radius: 4px;
    font-size: 14px;
    color: #606266;
    min-width: 120px;
    background-color: #fff;
}

.drug-search-input-wrapper {
    display: flex;
    align-items: center;
    flex-grow: 1;
    border: 1px solid #dcdfe6;
    border-radius: 4px;
    padding: 0 12px;
    background-color: #fff;
}

.drug-search-input-wrapper input {
    flex-grow: 1;
    border: none;
    outline: none;
    padding: 8px 0;
    font-size: 14px;
}

.drug-search-input-wrapper .el-icon-search {
    color: #c0c4cc;
    cursor: pointer;
    font-size: 16px;
}

.drug-action-buttons {
    display: flex;
    gap: 10px;
}

.drug-tab-btn {
    padding: 8px 18px;
    border-radius: 4px;
    border: 1px solid #dcdfe6;
    background-color: #fff;
    color: #606266;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}
.drug-tab-btn.active {
    background-color: #409eff;
    color: #fff;
    border-color: #409eff;
}
.drug-tab-btn:not(.active):hover {
    color: #409eff;
    border-color: #b3d8ff;
}

.drug-list-container {
  flex-grow: 1; /* Take available space */
  overflow-y: auto; /* Enable scrolling for the table */
  border: 1px solid #e4e7ed;
  border-radius: 4px;
}

.drug-table {
  width: 100%;
  border-collapse: collapse;
}

.drug-table th,
.drug-table td {
  padding: 10px 12px; 
  text-align: left;
  border-bottom: 1px solid #f0f2f5; /* Lighter border */
  font-size: 13px;
  vertical-align: middle;
}

.drug-table th {
  background-color: #f9fafc;
  color: #606266;
  font-weight: 500;
  white-space: nowrap;
  position: sticky; 
  top: 0;
  z-index: 1;
}

.drug-table input[type="checkbox"] {
    cursor: pointer;
}

.drug-table .drug-code {
    color: #909399;
    font-size: 11px;
}

.drug-table tbody tr:hover {
  background-color: #f5f7fa;
}

.no-drugs {
  text-align: center;
  padding: 30px;
  color: #909399;
  font-size: 14px;
}

.drug-pagination {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding-top: 15px;
    gap: 5px;
}

.drug-pagination button {
    background-color: #fff;
    border: 1px solid #dcdfe6;
    color: #606266;
    min-width: 30px;
    height: 30px;
    padding: 0 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    transition: all 0.2s ease;
}
.drug-pagination button:disabled {
    color: #c0c4cc;
    cursor: not-allowed;
    background-color: #f5f7fa;
}
.drug-pagination button:not(:disabled):hover {
    color: #409eff;
    border-color: #c6e2ff;
}
.drug-pagination button.active {
    background-color: #409eff;
    color: #fff;
    border-color: #409eff;
    cursor: default;
}
.drug-pagination button.active:hover {
    background-color: #409eff;
    color: #fff;
    border-color: #409eff;
}

.drug-modal-footer {
  display: flex;
  justify-content: space-between; /* Align hint left, buttons right */
  align-items: flex-end; /* Align items to bottom */
  padding: 15px 25px;
  border-top: 1px solid #e4e7ed;
  background-color: #f9fafc;
}

.hint-box {
    background-color: #fffbe6; /* Yellow hint background */
    border: 1px solid #ffe58f;
    border-radius: 4px;
    padding: 10px 15px;
    font-size: 12px;
    color: #8c6e2d;
    line-height: 1.6;
    flex-grow: 1; /* Allow hint box to take space */
    margin-right: 20px; /* Space between hint and buttons */
}

.drug-modal-footer .button-group {
     display: flex;
     gap: 10px;
}

.btn-cancel-drug {
  background-color: #fff;
  border: 1px solid #dcdfe6;
  color: #606266;
  padding: 8px 18px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}
.btn-cancel-drug:hover {
    background-color: #f5f7fa;
    border-color: #c0c4cc;
}

.btn-confirm-drug {
  background-color: #409eff;
  color: white;
  border: 1px solid #409eff;
  padding: 8px 18px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}
.btn-confirm-drug:hover {    
  background-color: #66b1ff; 
  border-color: #66b1ff;     
}
</style>


